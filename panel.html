<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AC LiNa · Panel</title>
<base href="./">
<style>
  :root{ --bg:#0f1115; --panel:#171a20; --border:#2a2f3a; --txt:#e9edf5; --muted:#a9b1be; }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--txt); }

  /* Header */
  header{
    position:sticky; top:0; z-index:20;
    display:grid; grid-template-columns: 1fr auto auto; gap:12px; align-items:center;
    padding:12px 16px; background:#10131a; border-bottom:1px solid var(--border);
  }
  .brand{ font-weight:800; letter-spacing:.14em; }
  .slogan{ font-size:11px; opacity:.8; margin-top:2px; letter-spacing:.28em; }
  .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .chip{ display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border:1px solid var(--border); border-radius:999px; cursor:pointer; font-size:14px; user-select:none; }
  .chip .dot{ width:12px; height:12px; border-radius:50%; border:1px solid #0005; }
  .chip.active{ outline:2px solid #ffffff22; }
  .right{ display:flex; gap:8px; align-items:center; }
  button, input[type="search"]{ background:#141821; color:var(--txt); border:1px solid var(--border); border-radius:10px; padding:8px 12px; font-size:14px; cursor:pointer; }
  input[type="search"]{ width:220px; }
  .toggle.active{ outline:2px solid #ffffff22; }

  /* ===== COLUMNAS FIJAS + MINI CARDS ===== */
  main.board{
    display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:16px; padding:16px;
  }
  .col{
    display:flex; flex-direction:column;
    background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px;
    height: calc(100vh - 150px); min-height:420px; min-width:0;
  }
  .col h2{ margin:0 0 10px; font-size:18px; }
  .list{
    flex:1 1 0;
    display:grid; grid-template-columns: repeat(3, 1fr); grid-auto-rows: 146px;
    gap:10px; align-content:start; overflow:auto; padding-right:4px;
    scrollbar-gutter: stable both-edges; min-width:0;
  }
  .col.dragover{ outline:2px dashed #8ea1c6; outline-offset:-6px; }

  /* Tarjeta mini */
  .card{
    position:relative; margin:0; padding:10px 10px 18px 10px; border-radius:14px;
    display:grid; grid-template-columns:48px 1fr; grid-template-rows:auto 1fr; column-gap:10px; row-gap:4px;
    box-shadow:0 6px 18px rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.22);
    min-width:0; min-height:0; cursor:grab;
  }
  .card:active{ transform:none; }
  .img{ grid-row:1 / span 2; width:48px; height:48px; border-radius:10px; border:1px solid #0003; background:#0002; overflow:hidden; display:flex; align-items:center; justify-content:center; }
  .img img{ width:100%; height:100%; object-fit:cover; }
  .main{ padding-right:66px; min-width:0; display:flex; flex-direction:column; }
  .line1{ font-weight:800; font-size:13.5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .line2{ margin-top:2px; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; opacity:.96; }
  .notes{ margin-top:4px; font-size:11.5px; line-height:1.15; max-height:1.2em; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; opacity:.9; }

  .badge-cat{
    position:absolute; top:6px; left:64px; font-size:11px; padding:2px 8px; border-radius:999px;
    background:rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.12);
    max-width: calc(100% - 120px); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .badge-ingreso, .badge-promesa{
    position:absolute; font-size:10.5px; line-height:1; opacity:.92;
    padding:4px 6px; border-radius:999px; background:rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.12);
  }
  .badge-ingreso{ top:6px; right:8px; }
  .badge-promesa{ bottom:4px; right:8px; }

  /* Menú rápido de categoría */
  .quick-cat{
    position:absolute; bottom:6px; left:8px; font-size:11px; background:#0002; border:1px solid rgba(255,255,255,.14); border-radius:8px; padding:2px 6px; cursor:pointer;
  }

  /* Anillo giratorio (soon/late) */
  .list .card::after{
    content:""; position:absolute; inset:0; border-radius:14px; padding:2px; pointer-events:none; display:none; z-index:2;
    -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
    -webkit-mask-composite: xor; mask-composite: exclude; animation: spin 2.8s linear infinite;
  }
  .list .ring-soon{ border-color: rgba(255, 90, 90, .65) !important; }
  .list .ring-late{ border-color: rgba(176, 0, 32, .9)  !important; }
  .list .ring-soon::after{ display:block; background: conic-gradient(from var(--angle,0deg), transparent 0 30%, rgba(255,90,90,.85) 34%, transparent 42% 100%); }
  .list .ring-late::after{ display:block; background: conic-gradient(from var(--angle,0deg), transparent 0 28%, rgba(255,160,160,.35) 32%, transparent 40% 100%); }
  @keyframes spin{ to{ --angle: 1turn; } }

  /* Gutter Archivo (overlay) */
  .archive-gutter{
    position:fixed; top:0; right:0; width:120px; height:100vh;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,.08));
    display:flex; align-items:center; justify-content:center;
    color:#fff; font-weight:600; letter-spacing:.06em; border-left:1px solid var(--border);
    z-index:50; transform: translateX(100%); transition: transform .15s ease; pointer-events:none;
  }
  .archive-gutter.show{ transform: translateX(0); pointer-events:auto; }
  .archive-gutter span{ transform: rotate(-90deg); opacity:.8; }

  footer{ padding:8px 16px; border-top:1px solid var(--border); color:var(--muted); font-size:12.5px; }

  /* Modales */
  dialog{ border:none; border-radius:14px; padding:0; background:#161a22; color:var(--txt); min-width:min(860px, 96vw); }
  .dlg-head{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border); }
  .dlg-body{ padding:12px 14px; display:grid; grid-template-columns: 1fr 320px; gap:12px; }
  .dlg-actions{ padding:12px 14px; border-top:1px solid var(--border); display:flex; gap:8px; justify-content:flex-end; }
  .form-row{ display:flex; gap:8px; align-items:center; margin-bottom:10px; }
  input[type="text"], input[type="date"], input[type="url"], textarea, select{
    width:100%; background:#121722; color:var(--txt); border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:14px;
  }
  textarea{ min-height:90px; resize:vertical; }
  .preview{ border:1px dashed var(--border); border-radius:12px; padding:10px; display:flex; flex-direction:column; align-items:center; gap:8px; }
  .preview img{ max-width:100%; max-height:220px; border-radius:10px; border:1px solid var(--border); object-fit:cover; }
  .btn-primary{ background:#2a5bd7; border:1px solid #2a5bd7; color:#fff; }
  .btn-danger{ background:#3a1f22; border:1px solid #5a2730; color:#fff; }

  @media (max-width:1100px){
    main.board{ grid-template-columns: 1fr; }
    .col{ height: calc(100vh - 180px); }
    .dlg-body{ grid-template-columns: 1fr; }
    .list{ grid-template-columns: repeat(2, 1fr); grid-auto-rows: 148px; }
  }
</style>
</head>
<body>
<header>
  <div>
    <div class="brand">ACLiNa</div>
    <div class="slogan">DESARROLLOS</div>
  </div>

  <div class="controls" id="legend"></div>

  <div class="right">
    <button id="btnBoth"  class="toggle active">Ambos</button>
    <button id="btnT1"    class="toggle">Turno 1</button>
    <button id="btnT2"    class="toggle">Turno 2</button>
    <input id="search" type="search" placeholder="Buscar…" />
    <button id="btnExport">Exportar CSV</button>
    <button id="btnSettings">Ajustes</button>
    <button id="btnLogout">Salir</button>
  </div>
</header>

<main class="board">
  <section class="col" data-col="recepcion"><h2>Recepción</h2><div class="list" id="recepcion"></div></section>
  <section class="col" data-col="diagnostico"><h2>Diagnóstico</h2><div class="list" id="diagnostico"></div></section>
  <section class="col" data-col="reparacion"><h2>Reparación</h2><div class="list" id="reparacion"></div></section>
  <section class="col" data-col="listo"><h2>Listo</h2><div class="list" id="listo"></div></section>
  <section class="col" data-col="entregado"><h2>Entregado</h2><div class="list" id="entregado"></div></section>
</main>

<!-- Gutter Archivo -->
<div id="archiveGutter" class="archive-gutter"><span>Soltar para archivar</span></div>

<!-- Dialogo de tarjeta -->
<dialog id="cardDialog">
  <form method="dialog" id="cardForm">
    <div class="dlg-head"><strong id="dlgTitle">Nueva tarjeta</strong><button type="button" id="dlgClose">Cerrar</button></div>
    <div class="dlg-body">
      <div>
        <div class="form-row"><label style="min-width:110px;">OT</label><input id="fOT" type="text" required></div>
        <div class="form-row"><label style="min-width:110px;">Producto</label><input id="fProducto" type="text" required></div>
        <div class="form-row"><label style="min-width:110px;">Cliente</label><input id="fCliente" type="text" required></div>
        <div class="form-row"><label style="min-width:110px;">A cargo</label>
          <select id="fTurno"><option value="T1">TURNO 1</option><option value="T2">TURNO 2</option></select></div>
        <div class="form-row"><label style="min-width:110px;">Notas</label><textarea id="fNotes"></textarea></div>
        <div class="form-row"><label style="min-width:110px;">Categoría</label><select id="fCategory"></select></div>
        <div class="form-row">
          <label style="min-width:110px;">Ingreso</label><input id="fIngreso" type="date">
          <label style="min-width:90px;">Prometida</label><input id="fPrometida" type="date" required>
        </div>
        <div class="form-row"><label style="min-width:110px;">Imagen URL</label><input id="fImageUrl" type="url" placeholder="https://…"></div>
        <div class="form-row"><label style="min-width:110px;">Imagen archivo</label><input id="fImageFile" type="file" accept="image/*"></div>
      </div>
      <div>
        <div class="preview"><div class="helper">Vista previa</div><img id="previewImg" style="display:none"><div class="helper" id="imgInfo"></div></div>
      </div>
    </div>
    <div class="dlg-actions">
      <button type="button" class="btn-danger" id="btnDelete" style="display:none;">Eliminar</button>
      <div style="flex:1;"></div>
      <button type="button" id="btnCancel">Cancelar</button>
      <button type="submit" class="btn-primary">Guardar</button>
    </div>
  </form>
</dialog>

<!-- Dialogo Presets -->
<dialog id="presetsDialog">
  <form method="dialog" id="presetsForm">
    <div class="dlg-head"><strong>Colores de categorías</strong><button type="button" id="pDlgClose">Cerrar</button></div>
    <div class="dlg-body" style="grid-template-columns:1fr;">
      <div id="presetsList"></div>
      <div class="helper">Se aplican a todas las tarjetas de esa categoría.</div>
    </div>
    <div class="dlg-actions"><button type="button" id="btnPresetsCancel">Cancelar</button><button type="submit" class="btn-primary">Guardar</button></div>
  </form>
</dialog>

<!-- Dialogo Ajustes -->
<dialog id="settingsDialog">
  <form method="dialog" id="settingsForm">
    <div class="dlg-head"><strong>Ajustes</strong><button type="button" id="sDlgClose">Cerrar</button></div>
    <div class="dlg-body" style="grid-template-columns:1fr;">
      <div class="form-row"><label style="min-width:220px;">Umbral próximo (horas)</label><input id="sDueSoon" type="number" min="12" max="168" step="6"></div>
      <div class="form-row"><label style="min-width:220px;">Días laborables (L a D)</label><div id="sWorkdays"></div></div>
      <div class="helper">Sábados y domingos desactivados por defecto.</div>
      <div style="margin-top:10px;">
        <button type="button" id="btnPresets" class="btn-primary">Editar presets</button>
      </div>
    </div>
    <div class="dlg-actions"><button type="button" id="btnSettingsCancel">Cancelar</button><button type="submit" class="btn-primary">Guardar</button></div>
  </form>
</dialog>

<footer> Doble clic en tarjeta para editar. Arrastrá entre tarjetas (orden manual). Arrastrá al borde derecho para archivar. Se sincroniza con TV en tiempo real.</footer>

<script type="module">
  /* ===== Firebase ===== */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB-Mx5Qqwg6KFMJSA-yUb-DFo7UjfqCpKY",
  authDomain: "aclinadev.firebaseapp.com",
  projectId: "aclinadev",
  storageBucket: "aclinadev.firebasestorage.app",
  messagingSenderId: "401991392253",
  appId: "1:401991392253:web:92400bc5d2503ed6879794",
};


  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  const DOC_ID = 'ac-lina';               // documento principal
  const REF    = doc(db,'kanban',DOC_ID); // estado
  const DISPLAY= doc(db,'kanban','display'); // control de turnos para TV

  /* ===== Estado local ===== */
  let data = {
    presets: [
      { key:'p1', name:'Presupuestos', color:'#2D9CDB' },
      { key:'p2', name:'Aceptado',     color:'#27AE60' },
      { key:'p3', name:'No Aceptado',  color:'#EB5757' },
      { key:'p4', name:'Garantía T',   color:'#9B51E0' },
      { key:'p5', name:'Garantía F',   color:'#F2994A' },
      { key:'p6', name:'Tareas Extra', color:'#E2B93B' },
    ],
    settings:{ dueSoonHours:42, workdays:[1,1,1,1,1,0,0] },
    recepcion:[], diagnostico:[], reparacion:[], listo:[], entregado:[], archivo:[]
  };
  let remoteLoaded = false;
  let currentEdit = { id:null, col:'recepcion' };
  let dragId = null;
  let activeFilters = new Set();
  let activeTurn = 'both';      // both, T1, T2
  let showT1 = true, showT2 = true;

  const $  = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);

  /* ===== Utilidades ===== */
  function uid(){ return 'id'+Math.random().toString(36).slice(2,9); }
  function getPreset(key){ return data.presets.find(p=>p.key===key) || data.presets[0]; }
  function luminance(hex){ const c=(hex||'#000').replace('#','').padEnd(6,'0'); const r=parseInt(c.slice(0,2),16)/255, g=parseInt(c.slice(2,4),16)/255, b=parseInt(c.slice(4,6),16)/255; const f=x=>(x<=0.03928)?x/12.92:Math.pow((x+0.055)/1.055,2.4); return 0.2126*f(r)+0.7152*f(g)+0.0722*f(b); }
  const textOn = bg => (luminance(bg)<0.5) ? '#fff' : '#111';
  const outline= bg => (textOn(bg)==='#fff') ? '#ffffff33' : '#00000022';
  const fmtDM  = d => !d ? '' : d.split('-').reverse().slice(0,2).join('/').replace(/^(\d{2})\/(\d{2}).*$/,'$1/$2');
  function parseISO(d){ if(!d) return null; const t=new Date(d+'T00:00:00'); t.setHours(0,0,0,0); return t; }
  function businessHoursUntil(from,to,wd){ if(!from||!to) return 0; const s=new Date(from); s.setHours(0,0,0,0); const e=new Date(to); e.setHours(0,0,0,0); if(s.getTime()===e.getTime()) return wd[s.getDay()]?24:0; const dir=(e>s)?1:-1; let cur=new Date(s), h=0; while((dir>0&&cur<e)||(dir<0&&cur>e)){ if(wd[cur.getDay()]) h+=24*dir; cur.setDate(cur.getDate()+dir); if(Math.abs((cur-s)/(1000*3600*24))>10000) break; } return h; }
  function hoursToDue(p){ if(!p) return Infinity; const today=new Date(); today.setHours(0,0,0,0); return businessHoursUntil(today, parseISO(p), data.settings.workdays); }
  function bytesOfDataURL(str){ if (!str || !str.startsWith('data:')) return 0; const b64 = str.split(',')[1] || ''; return Math.ceil(b64.length * 3/4); }

  /* ===== Render Leyenda ===== */
  function renderLegend(){
    const box = $('#legend'); box.innerHTML='';
    for(const p of data.presets){
      const chip = document.createElement('div');
      chip.className = 'chip' + (activeFilters.size && !activeFilters.has(p.key) ? '' : ' active');
      chip.dataset.key = p.key;
      chip.innerHTML = `<span class="dot" style="background:${p.color}"></span>${p.name}`;
      chip.addEventListener('click', ()=>{
        if(!activeFilters.size) activeFilters.add(p.key);
        else if(activeFilters.has(p.key)) activeFilters.delete(p.key);
        else activeFilters.add(p.key);
        render();
      });
      box.appendChild(chip);
    }
  }

  /* ===== Render Cards ===== */
  function cardNode(card){
    const p = getPreset(card.category||'p1');
    const bg = p.color, fg = textOn(bg), ol = outline(bg);
    const wrap = document.createElement('div');
    wrap.className = 'card';
    wrap.setAttribute('draggable','true');
    wrap.dataset.id = card.id;
    wrap.style.cssText = `background:${bg};color:${fg};border-color:${ol};text-shadow:${fg==='#fff'?'0 1px 2px rgba(0,0,0,.45)':'0 1px 0 rgba(255,255,255,.15)'};`;

    const hrs = hoursToDue(card.prometida);
    if (hrs <= 0) wrap.classList.add('ring-late');
    else if (hrs <= (data.settings?.dueSoonHours ?? 42)) wrap.classList.add('ring-soon');

    const imgBox = document.createElement('div'); imgBox.className='img';
    if(card.image){ const im=new Image(); im.src=card.image; imgBox.appendChild(im); }
    else { imgBox.style.border='1px dashed #0003'; imgBox.innerHTML='<div style="opacity:.6;font-size:11px">sin imagen</div>'; }

    const main = document.createElement('div'); main.className='main';
    const l1 = document.createElement('div'); l1.className='line1'; l1.textContent = `${card.ot||''} — ${card.producto||''}`.replace(/ — $/,'');
    const l2 = document.createElement('div'); l2.className='line2'; l2.textContent = `${card.cliente||''} — ${card.turno==='T2'?'T_2':'T_1'}`;
    const notes = document.createElement('div'); notes.className='notes'; if((card.notes||'').trim()) notes.textContent = card.notes;

    const bCat = document.createElement('div'); bCat.className='badge-cat'; bCat.textContent = getPreset(card.category).name;
    const bIng = document.createElement('div'); bIng.className='badge-ingreso'; bIng.textContent = card.ingreso?`Ing: ${fmtDM(card.ingreso)}`:'';
    const bPro = document.createElement('div'); bPro.className='badge-promesa'; bPro.textContent = card.prometida?`Prom: ${fmtDM(card.prometida)}`:'';

    const qCat = document.createElement('div'); qCat.className='quick-cat'; qCat.textContent='Estado'; qCat.title='Cambiar categoría';
    qCat.addEventListener('click', (e)=>{
      e.stopPropagation();
      const next = cyclePreset(card.category);
      card.category = next;
      scheduleSave();
      render();
    });

    main.appendChild(l1); main.appendChild(l2); if(notes.textContent) main.appendChild(notes);
    wrap.appendChild(imgBox); wrap.appendChild(main); wrap.appendChild(bCat); wrap.appendChild(bIng); wrap.appendChild(bPro); wrap.appendChild(qCat);

    wrap.addEventListener('dragstart', ()=>{ dragId = card.id; showArchiveGutter(true); });
    wrap.addEventListener('dragend', ()=>{ dragId = null; showArchiveGutter(false); });
    wrap.addEventListener('dblclick', ()=> openEditor(card.id));

    // filtros
    const q = ($('#search').value || '').toLowerCase();
    const hay = (t)=> (t||'').toLowerCase().includes(q);
    const hitsText = hay(card.ot)||hay(card.producto)||hay(card.cliente)||hay(card.notes);
    const hitsFilter = (!activeFilters.size) || activeFilters.has(card.category);
    const hitsShift = (card.turno === 'T1' ? showT1 : showT2) && (activeTurn==='both' || card.turno===activeTurn);
    if (!(hitsText && hitsFilter && hitsShift)) wrap.style.display = 'none';

    return wrap;
  }

  function render(){
    renderLegend();
    for(const col of ['recepcion','diagnostico','reparacion','listo','entregado']){
      const list = document.getElementById(col); list.innerHTML='';
      const arr = [...(data[col]||[])].sort((a,b)=>(a.pos??0)-(b.pos??0) || a.id.localeCompare(b.id));
      for(const c of arr) list.appendChild(cardNode(c));
    }
  }

  /* ===== Persistencia con Firestore ===== */
  async function loadFromCloud(){
    const snap = await getDoc(REF);
    if(snap.exists()){
      const d = snap.data();
      data.presets     = Array.isArray(d.presets)? d.presets : data.presets;
      data.settings    = d.settings? { ...data.settings, ...d.settings } : data.settings;
      for(const k of ['recepcion','diagnostico','reparacion','listo','entregado','archivo']){
        data[k] = Array.isArray(d[k]) ? d[k] : [];
      }
    }else{
      await setDoc(REF, data, {merge:true});
    }
    remoteLoaded = true; render();
  }
  let saveTimer=null;
  function scheduleSave(){ clearTimeout(saveTimer); saveTimer=setTimeout(saveToCloud, 400); }
  async function saveToCloud(){
    try{
      await setDoc(REF, data, {merge:true});
    }catch(e){ alert('No se pudo guardar en la nube. Se conserva copia local.'); }
  }

  // Live updates
  onSnapshot(REF, (snap)=>{
    if(!snap.exists()) return;
    const d=snap.data();
    if(!remoteLoaded) return;
    // fusionar cambios remotos (simple)
    for(const k of ['presets','settings','recepcion','diagnostico','reparacion','listo','entregado','archivo']){
      if(d[k]!==undefined) data[k]=d[k];
    }
    render();
  });

  // Sync de turno para TV
  onSnapshot(DISPLAY, (snap)=>{
    if(snap.exists()){ activeTurn = snap.data().activeTurn || 'both'; render(); }
  });

  async function setDisplayTurn(mode){ await setDoc(DISPLAY, {activeTurn: mode}, {merge:true}); }

  /* ===== Crear / Editar ===== */
  const dlg = $('#cardDialog');
  const fOT=$('#fOT'), fProd=$('#fProducto'), fCli=$('#fCliente'), fTurno=$('#fTurno'), fNotes=$('#fNotes'),
        fCat=$('#fCategory'), fIng=$('#fIngreso'), fPro=$('#fPrometida'),
        fImgUrl=$('#fImageUrl'), fImgFile=$('#fImageFile'),
        pImg=$('#previewImg'), pInfo=$('#imgInfo');

  function fillCategories(){
    fCat.innerHTML=''; for(const p of data.presets){ const o=document.createElement('option'); o.value=p.key; o.textContent=p.name; fCat.appendChild(o); }
  }
  function openNew(col='recepcion'){
    currentEdit={id:null,col}; $('#dlgTitle').textContent='Nueva tarjeta'; $('#btnDelete').style.display='none';
    fillCategories();
    fOT.value=''; fProd.value=''; fCli.value=''; fTurno.value='T1'; fNotes.value='';
    const todayISO=new Date().toISOString().slice(0,10);
    fIng.value=todayISO; fPro.value=todayISO; fCat.value=data.presets[0]?.key||'p1';
    fImgUrl.value=''; fImgFile.value=''; pImg.style.display='none'; pImg.src=''; pInfo.textContent='';
    dlg.showModal(); fOT.focus();
  }
  function findCard(id){
    for(const k of ['recepcion','diagnostico','reparacion','listo','entregado']){
      const i=data[k].findIndex(x=>x.id===id); if(i>=0) return {col:k,idx:i,card:data[k][i]};
    } return null;
  }
  function openEditor(id){
    const f=findCard(id); if(!f) return;
    currentEdit={id, col:f.col}; $('#dlgTitle').textContent='Editar tarjeta'; $('#btnDelete').style.display='inline-block';
    fillCategories();
    fOT.value=f.card.ot||''; fProd.value=f.card.producto||''; fCli.value=f.card.cliente||''; fTurno.value=f.card.turno||'T1';
    fNotes.value=f.card.notes||''; fIng.value=f.card.ingreso||''; fPro.value=f.card.prometida||''; fCat.value=f.card.category||data.presets[0]?.key||'p1';
    if(f.card.image){ pImg.src=f.card.image; pImg.style.display='block'; pInfo.textContent=f.card.image.startsWith('data:')?`DataURL ~${(bytesOfDataURL(f.card.image)/1024).toFixed(1)} KB`:'Imagen por URL'; }
    else { pImg.style.display='none'; pImg.src=''; pInfo.textContent=''; }
    fImgUrl.value = (f.card.image && !f.card.image.startsWith('data:')) ? f.card.image : ''; fImgFile.value='';
    dlg.showModal();
  }
  $('#cardForm').addEventListener('submit',(e)=>{
    e.preventDefault();
    const obj={ ot:fOT.value.trim(), producto:fProd.value.trim(), cliente:fCli.value.trim(), turno:fTurno.value,
      notes:fNotes.value, ingreso:fIng.value||null, prometida:fPro.value||null, category:fCat.value,
      pos: Date.now() };
    if(pImg.style.display==='block' && pImg.src) obj.image=pImg.src;
    else if(fImgUrl.value.trim()) obj.image=fImgUrl.value.trim();

    if(!currentEdit.id){ obj.id=uid(); data[currentEdit.col].unshift(obj); }
    else{ const f=findCard(currentEdit.id); if(f){ data[f.col][f.idx]={ id:f.card.id, ...obj, pos:f.card.pos??Date.now() }; } }
    dlg.close(); render(); scheduleSave();
  });
  $('#btnDelete').addEventListener('click',()=>{ if(!currentEdit.id) return; const f=findCard(currentEdit.id); if(f){ data[f.col].splice(f.idx,1); render(); scheduleSave(); } dlg.close(); });
  $('#btnCancel').addEventListener('click',()=>dlg.close()); $('#dlgClose').addEventListener('click',()=>dlg.close());

  // Imagen preview
  fImgFile.addEventListener('change',()=>{ const file=fImgFile.files?.[0]; if(!file) return; const r=new FileReader(); r.onload=()=>{ pImg.src=r.result; pImg.style.display='block'; pInfo.textContent=`DataURL ~${(bytesOfDataURL(r.result)/1024).toFixed(1)} KB`; }; r.readAsDataURL(file); });
  fImgUrl.addEventListener('input',()=>{ const u=fImgUrl.value.trim(); if(u){ pImg.src=u; pImg.style.display='block'; pInfo.textContent='Imagen por URL'; } else if(!fImgFile.files?.length){ pImg.style.display='none'; pImg.src=''; pInfo.textContent=''; } });

  /* ===== DnD entre columnas + orden manual ===== */
  $$('.col').forEach(col=>{
    const list = col.querySelector('.list');

    // Permitir arrastrar sobre la lista
    list.addEventListener('dragover', e=>{ e.preventDefault(); col.classList.add('dragover'); });
    list.addEventListener('dragleave', ()=> col.classList.remove('dragover'));

    // Reordenar dentro de la columna: insertar antes de la card bajo el cursor
    list.addEventListener('drop', e=>{
      e.preventDefault(); col.classList.remove('dragover'); if(!dragId) return;
      let card=null, fromCol=null;
      for(const k of ['recepcion','diagnostico','reparacion','listo','entregado']){
        const i=data[k].findIndex(x=>x.id===dragId);
        if(i>=0){ card=data[k].splice(i,1)[0]; fromCol=k; break; }
      }
      if(!card) return;

      // Calcular nueva posición según la card destino
      const children=[...list.children];
      const target = children.find(n=> n.getBoundingClientRect().left <= e.clientX &&
                                       n.getBoundingClientRect().right >= e.clientX &&
                                       n.getBoundingClientRect().top <= e.clientY &&
                                       n.getBoundingClientRect().bottom >= e.clientY);
      const arr = data[col.getAttribute('data-col')];
      if(!target){ arr.push(card); }
      else{
        const idx = arr.findIndex(x=>x.id===target.dataset.id);
        if(idx>=0) arr.splice(idx,0,card); else arr.push(card);
      }
      // Reasignar pos en orden
      const now = Date.now();
      data[col.getAttribute('data-col')] = arr.map((c,i)=> ({...c, pos: now + i}));
      render(); scheduleSave();
      dragId=null; showArchiveGutter(false);
    });

    // Doble clic en zona vacía crea nueva
    col.addEventListener('dblclick',(e)=>{ if(e.target.closest('.card')) return; openNew(col.getAttribute('data-col')); });
  });

  /* ===== Archivo (gutter) ===== */
  const gutter = $('#archiveGutter');
  function showArchiveGutter(show){ if(gutter) gutter.classList.toggle('show', !!show); }
  window.addEventListener('dragover', (e)=>{ if(!dragId) return; const nearRight=(window.innerWidth - e.clientX)<120; showArchiveGutter(nearRight); e.preventDefault(); });
  window.addEventListener('drop', (e)=>{
    e.preventDefault(); if(!dragId){ showArchiveGutter(false); return; }
    const nearRight=(window.innerWidth - e.clientX)<140;
    if(nearRight){
      let moved=null, fromCol=null;
      for(const k of ['recepcion','diagnostico','reparacion','listo','entregado']){
        const i=data[k].findIndex(x=>x.id===dragId);
        if(i>=0){ moved=data[k].splice(i,1)[0]; fromCol=k; break; }
      }
      if(moved){ moved.lastColumn=fromCol; data.archivo.unshift(moved); render(); scheduleSave(); }
    }
    dragId=null; showArchiveGutter(false);
  });

  /* ===== Presets ===== */
  const pDlg = $('#presetsDialog');
  $('#btnPresets').addEventListener('click',()=>{ buildPresetsForm(); pDlg.showModal(); });
  $('#pDlgClose').addEventListener('click',()=>pDlg.close());
  $('#btnPresetsCancel').addEventListener('click',()=>pDlg.close());
  function buildPresetsForm(){
    const box=$('#presetsList'); box.innerHTML='';
    for(const p of data.presets){
      const row=document.createElement('div'); row.className='form-row'; row.dataset.key=p.key;
      row.innerHTML=`<input type="text" value="${p.name}" disabled style="min-width:240px;"><input type="color" value="${p.color}">`;
      box.appendChild(row);
    }
  }
  $('#presetsForm').addEventListener('submit',(e)=>{
    e.preventDefault();
    [...$('#presetsList').children].forEach(r=>{
      const key=r.dataset.key; const color=r.querySelector('input[type="color"]').value;
      const p=getPreset(key); if(p) p.color=color;
    });
    pDlg.close(); render(); scheduleSave();
  });
  function cyclePreset(key){ const i=data.presets.findIndex(p=>p.key===key); const n=(i+1)%data.presets.length; return data.presets[n].key; }

  /* ===== Ajustes ===== */
  const sDlg=$('#settingsDialog');
  $('#btnSettings').addEventListener('click',()=>{ buildSettings(); sDlg.showModal(); });
  $('#sDlgClose').addEventListener('click',()=>sDlg.close());
  $('#btnSettingsCancel').addEventListener('click',()=>sDlg.close());
  function buildSettings(){
    $('#sDueSoon').value = data.settings.dueSoonHours ?? 42;
    const box=$('#sWorkdays'); box.innerHTML='';
    const labels=['L','M','X','J','V','S','D'];
    data.settings.workdays = data.settings.workdays || [1,1,1,1,1,0,0];
    data.settings.workdays.forEach((v,i)=>{
      const label=document.createElement('label'); label.style.marginRight='8px';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!v;
      cb.addEventListener('change',()=> data.settings.workdays[i]=cb.checked?1:0);
      label.appendChild(cb); label.appendChild(document.createTextNode(' '+labels[i]));
      box.appendChild(label);
    });
  }
  $('#settingsForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const v=parseInt($('#sDueSoon').value,10); if(!isNaN(v)) data.settings.dueSoonHours=Math.max(12,Math.min(168,v));
    sDlg.close(); render(); scheduleSave();
  });

  /* ===== Barra superior: filtros / export / logout ===== */
  $('#search').addEventListener('input', render);
  $('#btnLogout').addEventListener('click', ()=> signOut(auth));
  $('#btnExport').addEventListener('click', exportCSV);

  $('#btnBoth').addEventListener('click', async ()=>{ activeTurn='both'; showT1=showT2=true; setBtns(); await setDisplayTurn('both'); render(); });
  $('#btnT1').addEventListener('click',   async ()=>{ activeTurn='T1';   showT1=true; showT2=false; setBtns(); await setDisplayTurn('T1'); render(); });
  $('#btnT2').addEventListener('click',   async ()=>{ activeTurn='T2';   showT1=false; showT2=true; setBtns(); await setDisplayTurn('T2'); render(); });
  function setBtns(){
    $('#btnBoth').classList.toggle('active', activeTurn==='both');
    $('#btnT1').classList.toggle('active', activeTurn==='T1');
    $('#btnT2').classList.toggle('active', activeTurn==='T2');
  }

  /* ===== Export ===== */
  function exportCSV(){
    const rows=[['Columna','OT','Producto','Cliente','Turno','Ingreso','Prometida','Categoria','Notas']];
    for(const col of ['recepcion','diagnostico','reparacion','listo','entregado']){
      for(const c of data[col]){
        rows.push([col, c.ot||'', c.producto||'', c.cliente||'', c.turno||'', c.ingreso||'', c.prometida||'', getPreset(c.category).name, (c.notes||'').replace(/\n/g,' ')]);
      }
    }
    const csv = rows.map(r=> r.map(v=> `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='kanban.csv'; a.click(); URL.revokeObjectURL(url);
  }

  /* ===== Init ===== */
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href='login.html'; return; }
    await loadFromCloud(); render();
  });

</script>
</body>
</html>

