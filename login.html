<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ACLiNa · Login</title>
  <style>
    :root{ --bg:#0f1115; --panel:#171a20; --border:#2a2f3a; --txt:#e9edf5; }
    *{ box-sizing:border-box; }
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      background:var(--bg); color:var(--txt); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    }
    .box{
      width:min(360px, 94vw); background:var(--panel); border:1px solid var(--border);
      border-radius:14px; padding:20px; box-shadow:0 12px 30px rgba(0,0,0,.35);
    }
    .brand{ font-weight:800; letter-spacing:.16em; text-align:center; margin-bottom:2px; }
    .slogan{ text-align:center; font-size:12px; opacity:.85; margin-bottom:14px; letter-spacing:.28em; }
    h2{ margin:0 0 12px; font-size:18px; text-align:center; }
    form{ display:grid; gap:8px; }
    input,button{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      background:#141821; color:var(--txt); font-size:15px;
    }
    button{ cursor:pointer; }
    .btn-primary{ background:#2a5bd7; border-color:#2a5bd7; color:#fff; }
    .muted{ font-size:12px; opacity:.8; text-align:center; margin-top:6px; }
    .row{ display:flex; gap:8px; }
    .hidden{ display:none; }
    .error{ color:#ffb4b4; font-size:13px; text-align:center; min-height:18px; margin-top:6px;}
  </style>
  <script type="module">
    /* ================= Firebase ================= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // Tu config (pegada tal cual)
    const firebaseConfig = {
      apiKey: "AIzaSyB-Mx5Qqwg6KFMJSA-yUb-DFo7UjfqCpKY",
      authDomain: "aclinadev.firebaseapp.com",
      projectId: "aclinadev",
      storageBucket: "aclinadev.firebasestorage.app",
      messagingSenderId: "401991392253",
      appId: "1:401991392253:web:92400bc5d2503ed6879794",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ================= UI refs ================= */
    const loginBox   = document.getElementById('loginBox');
    const modeBox    = document.getElementById('modeBox');
    const errorBox   = document.getElementById('errorBox');
    const form       = document.getElementById('loginForm');
    const btnPanel   = document.getElementById('btnPanel');
    const btnDisplay = document.getElementById('btnDisplay');
    const btnLogout  = document.getElementById('btnLogout');

    /* ================= Helpers ================= */
    async function getRole(uid){
      try{
        const snap = await getDoc(doc(db,'users',uid));
        return snap.exists() ? (snap.data().role || 'user') : 'user';
      }catch(e){ return 'user'; }
    }

    function showLogin(){
      loginBox.classList.remove('hidden');
      modeBox.classList.add('hidden');
      errorBox.textContent = '';
    }
    function showModes(isAdmin){
      loginBox.classList.add('hidden');
      modeBox.classList.remove('hidden');
      btnPanel.classList.toggle('hidden', !isAdmin);
    }

    /* ================= Auth flow ================= */
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        const role = await getRole(user.uid);
        showModes(role === 'admin');  // admin: ve ambos botones
      }else{
        showLogin();
      }
    });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      errorBox.textContent = '';
      const email = form.email.value.trim();
      const pass  = form.pass.value;
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        // onAuthStateChanged hará el resto
      }catch(err){
        errorBox.textContent = mapError(err);
      }
    });

    btnPanel.onclick   = ()=> location.href = 'panel.html';
    btnDisplay.onclick = ()=> location.href = 'display.html';
    btnLogout.onclick  = ()=> signOut(auth);

    function mapError(err){
      const c = err?.code || '';
      if(c.includes('invalid-credential')) return 'Email o contraseña incorrectos.';
      if(c.includes('too-many-requests'))  return 'Demasiados intentos. Esperá un momento.';
      if(c.includes('network-request-failed')) return 'Sin conexión. Verificá internet.';
      return err.message || 'Error al iniciar sesión.';
    }
  </script>
</head>
<body>
  <div class="box">
    <div class="brand">ACLiNa</div>
    <div class="slogan">DESARROLLOS</div>

    <!-- Login -->
    <div id="loginBox">
      <h2>Iniciar sesión</h2>
      <form id="loginForm" autocomplete="on">
        <input type="email" name="email" placeholder="Email" required />
        <input type="password" name="pass" placeholder="Contraseña" required />
        <button class="btn-primary" type="submit">Ingresar</button>
      </form>
      <div id="errorBox" class="error"></div>
      <div class="muted">Usá el usuario creado en Firebase Auth.</div>
    </div>

    <!-- Selector de modo -->
    <div id="modeBox" class="hidden">
      <h2>Bienvenido</h2>
      <div class="row" style="margin-bottom:8px; flex-direction:column; gap:8px;">
        <button id="btnPanel" class="btn-primary hidden">Panel de Control</button>
        <button id="btnDisplay" class="btn-primary">Pantalla</button>
      </div>
      <button id="btnLogout">Cerrar sesión</button>
    </div>
  </div>
</body>
</html>




